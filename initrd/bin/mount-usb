#!/bin/sh
# Mount a USB device
. /etc/functions

enable_usb

#OEM reownership, when attempting to load /media/oem-provisioning, 
#requires usb-storage.ko module loaded, loaded here, modifying 
#PCR 5, through /sbin/insmod script.
#
#We bypass that measurement here, so the PCR 5 is the same
#when calling kexec-seal-key in OEM mode then when calling 
#kexec-unseal-key in normal boot mode.
if [ -e /boot/oem ]; then
  alias insmod='busybox insmod'
fi

if ! lsmod | grep -q usb_storage; then
	insmod /lib/modules/usb-storage.ko \
	|| die "usb_storage: module load failed"
	sleep 5
fi

if [ ! -d /media ]; then
	mkdir /media || die "Unable to create /media directory"
fi

if [ -z "$1" ]; then
	mount -o ro /media || warn "Unable to mount /media in Read Only mode"
else
	mount -o ro $1 /media || warn "unable to mount $1 on /media in Read Only mode"
fi
